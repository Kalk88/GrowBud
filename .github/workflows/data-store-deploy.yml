name: Data store deploy
on:
  push:
    branches:
      - master

    paths:
      - "server/data-store/**"

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1
      - name: Install dependencies
        run: |
          cd server/data-store
          npm install
          npm run tsc-build
      - name: Push default
        env:
          PROJECT_ID: ${{secrets.GCLOUD_PROJECT_ID}}
          FIREBASEAPIKEY: ${{secrets.FIREBASEAPIKEY}}
        run: |
          cd server/data-store
          cp example.app.yaml app.default.yaml
          sed -i "s/projectId/$PROJECT_ID/g" app.default.yaml
          sed -i "s/fbapikey/$FIREBASEAPIKEY/g" app.default.yaml
      - uses: actions-hub/gcloud@master
        env:
          PROJECT_ID: ${{secrets.GCLOUD_PROJECT_ID}}
          APPLICATION_CREDENTIALS: ${{secrets.GOOGLE_APPLICATION_CREDENTIALS}}
        with:
          args: app deploy server/data-store/app.default.yaml
      - name: Push master
        env:
          PROJECT_ID: ${{secrets.MASTER_GCLOUD_PROJECT_ID}}
          FIREBASEAPIKEY: ${{secrets.MASTER_FIREBASE_APIKEY}}
        run: |
          cd server/data-store
          cp example.app.yaml app.master.yaml
          sed -i "s/projectId/$PROJECT_ID/g" app.master.yaml
          sed -i "s/fbapikey/$FIREBASEAPIKEY/g" app.master.yaml
      - uses: actions-hub/gcloud@master
        env:
          PROJECT_ID: ${{secrets.MASTER_GCLOUD_PROJECT_ID}}
          APPLICATION_CREDENTIALS: ${{secrets.MASTER_GOOGLE_APPLICATION_CREDENTIALS}}
        with:
          args: app deploy server/data-store/app.master.yaml